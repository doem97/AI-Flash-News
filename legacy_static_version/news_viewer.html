<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©é¤ AI é€Ÿè¯»</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="header-content">
                <h1 class="title">
                    <span class="icon">ğŸŒ…</span>
                    <span id="pageTitle">æ—©é¤ AI é€Ÿè¯»</span>
                </h1>
                <div class="date-selector">
                    <button id="prevDay" class="date-btn" title="å‰ä¸€å¤©">â—€</button>
                    <span id="currentDate" class="current-date">åŠ è½½ä¸­...</span>
                    <button id="nextDay" class="date-btn" title="åä¸€å¤©">â–¶</button>
                    <button id="todayBtn" class="today-btn">ä»Šå¤©</button>
                </div>
            </div>
        </header>

        <!-- æ–°é—»å†…å®¹ -->
        <main class="main-content">
            <div id="newsContainer" class="news-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ–°é—»...</p>
                </div>
            </div>

            <!-- å…ƒæ•°æ® -->
            <footer class="metadata" id="metadata" style="display: none;">
                <div class="metadata-item">
                    <span class="metadata-icon">ğŸ“Š</span>
                    <span id="totalNews">0</span> æ¡æ–°é—»
                </div>
                <div class="metadata-item">
                    <span class="metadata-icon">ğŸŒ</span>
                    <span id="sourcesCount">0</span> ä¸ªæ•°æ®æº
                </div>
                <div class="metadata-item">
                    <span class="metadata-icon">â±ï¸</span>
                    ç”Ÿæˆäº <span id="generatedTime">--:--</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-icon">ğŸ—‘ï¸</span>
                    å·²å»é‡ <span id="duplicatesRemoved">0</span> æ¡
                </div>
            </footer>
        </main>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions">
            <button id="copyBtn" class="action-btn">
                <span>ğŸ“‹</span> å¤åˆ¶æ–‡æœ¬
            </button>
            <button id="refreshBtn" class="action-btn">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
            <button id="shareBtn" class="action-btn">
                <span>ğŸ“¤</span> åˆ†äº«
            </button>
        </div>

        <!-- å†å²åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰ -->
        <div class="history-panel" id="historyPanel" style="display: none;">
            <h3>å†å²ç®€æŠ¥</h3>
            <ul id="historyList"></ul>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let currentNewsData = null;
        let currentDateStr = null;
        let availableDates = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            bindEvents();
        });

        async function initApp() {
            // è·å–å¯ç”¨çš„æ—¥æœŸåˆ—è¡¨
            await loadAvailableDates();

            // åŠ è½½ä»Šå¤©çš„æ–°é—»æˆ–æœ€æ–°çš„æ–°é—»
            const today = formatDate(new Date());
            if (availableDates.includes(today)) {
                loadNews(today);
            } else if (availableDates.length > 0) {
                // åŠ è½½æœ€æ–°çš„
                loadNews(availableDates[0]);
            } else {
                showError('æœªæ‰¾åˆ°ä»»ä½•æ–°é—»æ•°æ®ã€‚è¯·å…ˆè¿è¡Œ generate_news.py ç”Ÿæˆæ–°é—»ã€‚');
            }
        }

        async function loadAvailableDates() {
            // å°è¯•è·å–æœ€è¿‘30å¤©çš„æ—¥æœŸæ–‡ä»¶
            const dates = [];
            const today = new Date();

            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = formatDate(date);

                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                try {
                    const response = await fetch(`${dateStr}.json`);
                    if (response.ok) {
                        dates.push(dateStr);
                    }
                } catch (e) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡
                }
            }

            availableDates = dates;
            return dates;
        }

        async function loadNews(dateStr) {
            showLoading();

            try {
                const response = await fetch(`${dateStr}.json`);

                if (!response.ok) {
                    throw new Error(`æ— æ³•åŠ è½½ ${dateStr}.json`);
                }

                const data = await response.json();
                currentNewsData = data;
                currentDateStr = dateStr;

                renderNews(data);
                renderMetadata(data.metadata);
                updateDateDisplay(dateStr);

            } catch (error) {
                showError(`åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        function renderNews(data) {
            const container = document.getElementById('newsContainer');
            container.innerHTML = '';

            const newsList = data.news || [];

            if (newsList.length === 0) {
                container.innerHTML = '<div class="no-news">ä»Šæ—¥æš‚æ— æ–°é—»</div>';
                return;
            }

            newsList.forEach((newsItem, index) => {
                const newsCard = createNewsCard(newsItem, index);
                container.appendChild(newsCard);
            });
        }

        function createNewsCard(newsItem, index) {
            const card = document.createElement('div');
            card.className = `news-card importance-${newsItem.importance || 'medium'}`;

            // é‡è¦æ€§å›¾æ ‡
            const importanceIcons = {
                'critical': 'ğŸ”¥',
                'high': 'ğŸ“Œ',
                'medium': 'Â·'
            };
            const icon = importanceIcons[newsItem.importance] || 'Â·';

            // æ–°é—»å†…å®¹
            const content = document.createElement('div');
            content.className = 'news-content';

            const text = document.createElement('p');
            text.className = 'news-text';
            text.innerHTML = `<span class="news-icon">${icon}</span> ${newsItem.content}`;

            content.appendChild(text);

            // å…³é”®è¯æ ‡ç­¾
            if (newsItem.keywords && newsItem.keywords.length > 0) {
                const tags = document.createElement('div');
                tags.className = 'news-tags';

                newsItem.keywords.forEach(keyword => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = `#${keyword}`;
                    tags.appendChild(tag);
                });

                content.appendChild(tags);
            }

            // åº•éƒ¨ä¿¡æ¯ï¼ˆæ¥æºå’Œé“¾æ¥ï¼‰
            if (newsItem.source || newsItem.url) {
                const footer = document.createElement('div');
                footer.className = 'news-footer';

                if (newsItem.source) {
                    const source = document.createElement('span');
                    source.className = 'news-source';
                    source.textContent = newsItem.source;
                    footer.appendChild(source);
                }

                if (newsItem.url) {
                    const link = document.createElement('a');
                    link.className = 'news-link';
                    link.href = newsItem.url;
                    link.target = '_blank';
                    link.textContent = 'æŸ¥çœ‹åŸæ–‡ â†’';
                    footer.appendChild(link);
                }

                content.appendChild(footer);
            }

            card.appendChild(content);

            return card;
        }

        function renderMetadata(metadata) {
            if (!metadata) return;

            document.getElementById('totalNews').textContent = metadata.total_news || 0;
            document.getElementById('sourcesCount').textContent =
                (metadata.sources_checked || []).length;
            document.getElementById('duplicatesRemoved').textContent =
                metadata.duplicates_removed || 0;

            if (metadata.generated_at) {
                const time = new Date(metadata.generated_at);
                document.getElementById('generatedTime').textContent =
                    time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }

            document.getElementById('metadata').style.display = 'flex';
        }

        function updateDateDisplay(dateStr) {
            const date = new Date(dateStr);
            const formatted = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short'
            });

            document.getElementById('currentDate').textContent = formatted;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const currentIndex = availableDates.indexOf(dateStr);
            document.getElementById('prevDay').disabled = currentIndex >= availableDates.length - 1;
            document.getElementById('nextDay').disabled = currentIndex <= 0;
        }

        function bindEvents() {
            // æ—¥æœŸå¯¼èˆª
            document.getElementById('prevDay').addEventListener('click', () => {
                const currentIndex = availableDates.indexOf(currentDateStr);
                if (currentIndex < availableDates.length - 1) {
                    loadNews(availableDates[currentIndex + 1]);
                }
            });

            document.getElementById('nextDay').addEventListener('click', () => {
                const currentIndex = availableDates.indexOf(currentDateStr);
                if (currentIndex > 0) {
                    loadNews(availableDates[currentIndex - 1]);
                }
            });

            document.getElementById('todayBtn').addEventListener('click', () => {
                const today = formatDate(new Date());
                if (availableDates.includes(today)) {
                    loadNews(today);
                } else {
                    showToast('ä»Šå¤©çš„æ–°é—»å°šæœªç”Ÿæˆ');
                }
            });

            // æ“ä½œæŒ‰é’®
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadNews(currentDateStr);
            });
            document.getElementById('shareBtn').addEventListener('click', shareNews);
        }

        async function copyToClipboard() {
            if (!currentNewsData) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                return;
            }

            let text = `${currentNewsData.title} - ${currentNewsData.date_formatted}\n\n`;

            currentNewsData.news.forEach((item, index) => {
                const icons = { 'critical': 'ğŸ”¥', 'high': 'ğŸ“Œ', 'medium': 'Â·' };
                const icon = icons[item.importance] || 'Â·';
                text += `${icon} ${item.content}\n\n`;
            });

            text += `\nç”Ÿæˆæ—¶é—´: ${currentNewsData.metadata.generated_at}\n`;
            text += `æ–°é—»æ€»æ•°: ${currentNewsData.metadata.total_news}\n`;

            try {
                await navigator.clipboard.writeText(text);
                showToast('âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        function shareNews() {
            if (!currentNewsData) return;

            const url = window.location.href;
            const title = `${currentNewsData.title} - ${currentNewsData.date_formatted}`;

            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).catch(() => {});
            } else {
                showToast('æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½');
            }
        }

        // å·¥å…·å‡½æ•°
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showLoading() {
            document.getElementById('newsContainer').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ–°é—»...</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('newsContainer').innerHTML = `
                <div class="error">
                    <p>âŒ ${message}</p>
                </div>
            `;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
